<template>
  <div class="h-full flex flex-col bg-gray-100 p-2" style="height: calc(100vh - 100px)">
    <div class="mb-2 flex items-center justify-between rounded bg-white p-3 shadow-sm">
      <div class="flex items-center gap-4">
        <n-button size="small" @click="$router.back()">è¿”å›ä¸Šçº§</n-button>
        <span class="text-lg font-bold">ğŸ¯ æ ‡æ³¨å·¥ä½œå°ï¼š{{ currentName }}</span>
      </div>
      <div>
        <n-tag type="info" class="mr-2">é¡¹ç›® ID: {{ projectId }}</n-tag>
      </div>
    </div>

    <div class="flex flex-1 gap-2 overflow-hidden">
      <div
        class="relative flex flex-1 items-center justify-center overflow-hidden rounded bg-black shadow-inner"
      >
        <div
          v-if="!hasClicked"
          class="pointer-events-none absolute top-5 z-10 rounded-full bg-black/70 px-4 py-2 text-white shadow-lg"
        >
          ğŸ‘† è¯·ç‚¹å‡»å…¨æ™¯å›¾ä¸­çš„ç›®æ ‡ç‰©ä½“ä¸­å¿ƒ
        </div>

        <img
          ref="panoImgRef"
          :src="currentUrl"
          class="max-h-full max-w-full cursor-crosshair transition-transform duration-300"
          draggable="false"
          @click="handlePanoClick"
        />

        <div
          v-if="clickPos.visible"
          class="pointer-events-none absolute h-4 w-4 transform border-2 border-white rounded-full bg-red-500 shadow-md -translate-x-1/2 -translate-y-1/2"
          :style="{ left: clickPos.x + 'px', top: clickPos.y + 'px' }"
        ></div>
      </div>

      <div class="w-[400px] flex flex-col overflow-y-auto rounded bg-white p-4 shadow-sm">
        <n-spin :show="loadingCrop">
          <n-space vertical size="large">
            <div class="flex items-center justify-between border-b pb-2">
              <h3 class="text-lg font-bold">ğŸ”­ å±€éƒ¨é€è§†è§†å›¾</h3>
              <n-tag :type="perspectiveData ? 'success' : 'default'">
                {{ perspectiveData ? 'è§†è§’å·²é”å®š' : 'ç­‰å¾…é€‰ç‚¹' }}
              </n-tag>
            </div>

            <div class="rounded bg-gray-50 p-3">
              <div class="mb-1 flex justify-between text-sm font-bold text-gray-600">
                <span>è§†åœºè§’ (FOV)</span>
                <span>{{ fov }}Â°</span>
              </div>
              <n-slider
                v-model:value="fov"
                :min="30"
                :max="120"
                :step="5"
                :disabled="!hasClicked"
                @update:value="refreshCrop"
              />
            </div>

            <div
              class="relative aspect-square w-full flex select-none items-center justify-center overflow-hidden border-2 border-gray-300 rounded border-dashed bg-gray-100"
            >
              <div v-if="!perspectiveData" class="flex flex-col items-center text-sm text-gray-400">
                <span class="mb-2 text-4xl">ğŸ“¸</span>
                åœ¨å·¦ä¾§ç‚¹å‡»åç”Ÿæˆè§†å›¾
              </div>

              <div
                v-else
                ref="drawBoardRef"
                class="relative h-full w-full cursor-crosshair"
                draggable="false"
                @mousedown="startDrawing"
                @mousemove="drawing"
                @mouseup="endDrawing"
                @mouseleave="endDrawing"
              >
                <img
                  :src="perspectiveData.image_base64"
                  class="pointer-events-none h-full w-full select-none"
                  draggable="false"
                />

                <div
                  v-if="isDrawing"
                  class="pointer-events-none absolute border-2 border-blue-500 bg-blue-500/20"
                  :style="drawingStyle"
                ></div>

                <div
                  v-if="finalBox"
                  class="absolute border-2 border-green-500 bg-green-500/20"
                  :style="finalBoxStyle"
                ></div>
              </div>
            </div>

            <div v-if="perspectiveData" class="mt-2">
              <n-form-item label="é€‰æ‹©ç‰©ä½“ç±»åˆ« (æ¥è‡ªé¡¹ç›®é…ç½®)">
                <n-select
                  v-model:value="selectedLabelId"
                  :options="labelOptions"
                  placeholder="è¯·é€‰æ‹©æ ‡ç­¾"
                  class="w-full"
                />
              </n-form-item>

              <n-button
                type="primary"
                size="large"
                block
                :disabled="!finalBox || !selectedLabelId"
                :loading="submitLoading"
                class="mt-2"
                @click="submitAnnotation"
              >
                ğŸ’¾ ä¿å­˜æ ‡æ³¨ç»“æœ
              </n-button>

              <div class="bg-gray-80 mt-4 break-all rounded p-3 text-xs font-mono text-gray-500">
                <p><b>Debug Info:</b></p>
                <p>Theta (Î¸): {{ perspectiveData.center_theta.toFixed(4) }}</p>
                <p>Phi (Ï†): {{ perspectiveData.center_phi.toFixed(4) }}</p>
                <p v-if="finalBox">
                  Box: [x:{{ Math.round(finalBox.x) }}, y:{{ Math.round(finalBox.y) }}, w:{{
                    Math.round(finalBox.w)
                  }}, h:{{ Math.round(finalBox.h) }}]
                </p>
              </div>
            </div>
          </n-space>
        </n-spin>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, computed, onMounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { NButton, NSpace, NSlider, NSelect, NTag, NSpin, NFormItem, useMessage } from 'naive-ui'
import imageApi from '@/api/image'
import projectApi from '@/api/project'

const route = useRoute()
const router = useRouter()
const message = useMessage()

// è·¯ç”±ä¼ å‚çŠ¶æ€
const projectId = ref(null)
const currentId = ref(null)
const currentUrl = ref('')
const currentName = ref('')

// ä¸šåŠ¡çŠ¶æ€
const hasClicked = ref(false)
const loadingCrop = ref(false)
const submitLoading = ref(false)

// æ ‡ç­¾ç›¸å…³ (ä»é¡¹ç›®é…ç½®ä¸­åŠ¨æ€è·å–)
const labelOptions = ref([])
const selectedLabelId = ref(null)

// æ ¸å¿ƒå‚æ•°
const fov = ref(90)
const perspectiveData = ref(null)
const realCoords = reactive({ u: 0, v: 0 })
const clickPos = reactive({ visible: false, x: 0, y: 0 })

// ç”»æ¿ç›¸å…³
const drawBoardRef = ref(null)
const isDrawing = ref(false)
const startPos = reactive({ x: 0, y: 0 })
const currPos = reactive({ x: 0, y: 0 })
const finalBox = ref(null)

// åˆå§‹åŒ–ï¼šè·å–è·¯ç”±å‚æ•°å¹¶æ‹‰å–é¡¹ç›®æ ‡ç­¾
onMounted(() => {
  const { projectId: pid, imageId, url, name } = route.query
  if (pid && imageId) {
    projectId.value = parseInt(pid)
    currentId.value = parseInt(imageId)
    currentUrl.value = url
    currentName.value = name

    // åˆå§‹åŒ–æ‹‰å–å½“å‰é¡¹ç›®çš„æ ‡ç­¾åˆ—è¡¨
    fetchProjectLabels()
  } else {
    message.warning('å‚æ•°ç¼ºå¤±ï¼Œè¯·ä»é¡¹ç›®è¯¦æƒ…é¡µè¿›å…¥')
    router.back()
  }
})

// åŠ¨æ€è·å–æ ‡ç­¾ä¸‹æ‹‰åˆ—è¡¨
const fetchProjectLabels = async () => {
  try {
    const res = await projectApi.getLabels(projectId.value)
    const labels = res.data || res || []
    // è½¬æ¢ä¸º Naive UI n-select éœ€è¦çš„æ ¼å¼: { label: 'æ˜¾ç¤ºæ–‡æœ¬', value: 'ç»‘å®šçš„å€¼' }
    labelOptions.value = labels.map((item) => ({
      label: item.name,
      value: item.id, // ç»‘å®šçœŸå®æ•°æ®åº“ ID
    }))

    // å¦‚æœæœ‰æ ‡ç­¾ï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
    if (labelOptions.value.length > 0) {
      selectedLabelId.value = labelOptions.value[0].value
    } else {
      message.warning('å½“å‰é¡¹ç›®è¿˜æœªé…ç½®æ ‡ç­¾ï¼Œè¯·å…ˆè¿”å›ä¸Šçº§æ·»åŠ æ ‡ç­¾')
    }
  } catch (error) {
    console.error('è·å–æ ‡ç­¾å¤±è´¥', error)
  }
}

// 1. å…¨æ™¯å›¾ç‚¹å‡»å¤„ç† (æ ¸å¿ƒï¼šè®¡ç®—ç‰©ç†åƒç´ æ˜ å°„)
const handlePanoClick = async (e) => {
  const img = e.target
  const rect = img.getBoundingClientRect()

  // è®°å½•å±å¹•ç›¸å¯¹åæ ‡
  const x = e.clientX - rect.left
  const y = e.clientY - rect.top
  clickPos.x = x
  clickPos.y = y
  clickPos.visible = true

  // è®¡ç®—åŸå§‹å›¾åƒçš„çœŸå®åƒç´ åæ ‡ (Natural Size)
  const scaleX = img.naturalWidth / rect.width
  const scaleY = img.naturalHeight / rect.height
  realCoords.u = x * scaleX
  realCoords.v = y * scaleY

  hasClicked.value = true
  await refreshCrop()
}

// 2. è¯·æ±‚é€è§†åˆ‡ç‰‡ç®—æ³•
const refreshCrop = async () => {
  if (!hasClicked.value) return
  loadingCrop.value = true
  finalBox.value = null // æ¸…é™¤ä¹‹å‰ç”»çš„æ¡†

  try {
    const res = await imageApi.getPerspective({
      image_id: currentId.value,
      u: realCoords.u,
      v: realCoords.v,
      fov: fov.value,
    })
    perspectiveData.value = res.data || res
  } catch (err) {
    message.error('åˆ‡å›¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯ç®—æ³•è¿è¡ŒçŠ¶æ€')
  } finally {
    loadingCrop.value = false
  }
}

// 3. ç”»æ¿é€»è¾‘ (åŸç”Ÿè®¡ç®—)
const getOffset = (e) => {
  const rect = drawBoardRef.value.getBoundingClientRect()
  return {
    x: e.clientX - rect.left,
    y: e.clientY - rect.top,
  }
}

const startDrawing = (e) => {
  isDrawing.value = true
  finalBox.value = null
  const { x, y } = getOffset(e)
  startPos.x = x
  startPos.y = y
  currPos.x = x
  currPos.y = y
}

const drawing = (e) => {
  if (!isDrawing.value) return
  const { x, y } = getOffset(e)
  // é™åˆ¶é¼ æ ‡ä¸èƒ½ç”»å‡ºè¾¹ç•Œ
  const rect = drawBoardRef.value.getBoundingClientRect()
  currPos.x = Math.max(0, Math.min(x, rect.width))
  currPos.y = Math.max(0, Math.min(y, rect.height))
}

const endDrawing = () => {
  if (!isDrawing.value) return
  isDrawing.value = false

  const w = Math.abs(currPos.x - startPos.x)
  const h = Math.abs(currPos.y - startPos.y)
  const x = Math.min(currPos.x, startPos.x)
  const y = Math.min(currPos.y, startPos.y)

  // é˜²æ­¢ç‚¹å‡»è¯¯è§¦ï¼Œå®½é«˜å¤§äº 5 åƒç´ æ‰ç®—æœ‰æ•ˆæ¡†
  if (w > 5 && h > 5) {
    finalBox.value = { x, y, w, h }
  }
}

// 4. åŠ¨æ€è®¡ç®—æ¡†çš„æ ·å¼
const drawingStyle = computed(() => {
  const w = Math.abs(currPos.x - startPos.x)
  const h = Math.abs(currPos.y - startPos.y)
  const left = Math.min(currPos.x, startPos.x)
  const top = Math.min(currPos.y, startPos.y)
  return { left: `${left}px`, top: `${top}px`, width: `${w}px`, height: `${h}px` }
})

const finalBoxStyle = computed(() => {
  if (!finalBox.value) return {}
  return {
    left: `${finalBox.value.x}px`,
    top: `${finalBox.value.y}px`,
    width: `${finalBox.value.w}px`,
    height: `${finalBox.value.h}px`,
  }
})

// 5. æäº¤ç»ˆæ€æ•°æ®åˆ°æ•°æ®åº“
const submitAnnotation = async () => {
  if (!finalBox.value || !selectedLabelId.value) return

  submitLoading.value = true
  // æŒ‰ç…§åç«¯çš„ AnnotationCreate Schema ç»„è£…æ•°æ®
  const payload = {
    label_id: selectedLabelId.value,
    center_theta: perspectiveData.value.center_theta,
    center_phi: perspectiveData.value.center_phi,
    fov: perspectiveData.value.fov,
    box_x: finalBox.value.x,
    box_y: finalBox.value.y,
    box_w: finalBox.value.w,
    box_h: finalBox.value.h,
  }

  try {
    await imageApi.saveAnnotation(currentId.value, payload)
    message.success('ğŸ‰ æ ‡æ³¨ä¿å­˜æˆåŠŸï¼ä½ å¯ä»¥ç»§ç»­ç‚¹å‡»å…¶ä»–ä½ç½®')
    finalBox.value = null // æ¸…ç©ºæ¡†ï¼Œæ–¹ä¾¿è¿ç»­æ ‡æ³¨
  } catch (err) {
    message.error('ä¿å­˜å¤±è´¥')
  } finally {
    submitLoading.value = false
  }
}
</script>
